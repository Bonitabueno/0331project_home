<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>말랑 젤리 스택 Jelly Stack</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Pretendard', 'Apple SD Gothic Neo', sans-serif;
      box-sizing: border-box;
      background: linear-gradient(135deg, #b3e5fc 0%, #f8bbd0 100%);
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }
    #game-container {
      margin-top: 38px;
      background: rgba(255,255,255,0.18);
      border-radius: 28px;
      box-shadow: 0 4px 32px 0 rgba(150, 150, 200, 0.22), 0 1.5px 0 #fff inset;
      padding: 24px 10px 10px 10px;
      width: 320px;
      min-height: 520px;
      position: relative;
      overflow: hidden;
      border: 3px solid #fff8;
    }
    .title {
      text-align: center;
      font-size: 2.1rem;
      font-weight: bold;
      color: #ff80ab;
      letter-spacing: 2px;
      margin-bottom: 18px;
      text-shadow: 0 2px 8px #fff7, 0 1px 0 #fff;
      user-select: none;
    }
    .cloud {
      position: absolute;
      z-index: 1;
      opacity: 0.48;
      animation: cloud-move 18s linear infinite;
      pointer-events: none;
    }
    .cloud.c1 { top: 30px; left: -70px; width: 90px; animation-delay: 0s;}
    .cloud.c2 { top: 120px; left: 170px; width: 110px; animation-delay: 4s;}
    .cloud.c3 { top: 200px; left: 60px; width: 60px; animation-delay: 8s;}
    @keyframes cloud-move {
      0% { transform: translateX(0);}
      100% { transform: translateX(380px);}
    }
    #game-canvas {
      display: block;
      background: linear-gradient(180deg, #e3f2fd 0%, #f8bbd0 100%);
      border-radius: 18px;
      box-shadow: 0 1.5px 0 #fff inset;
      margin: 0 auto;
      width: 300px;
      height: 400px;
      position: relative;
      z-index: 2;
      touch-action: manipulation;
    }
    #score-board {
      width: 300px;
      margin: 0 auto 10px auto;
      text-align: center;
      font-size: 1.1rem;
      font-weight: bold;
      color: #ba68c8;
      letter-spacing: 1.2px;
      background: rgba(255,255,255,0.77);
      border-radius: 12px;
      padding: 7px 0;
      box-shadow: 0 1.5px 0 #fff inset;
      user-select: none;
    }
    .btn {
      display: inline-block;
      background: linear-gradient(90deg,#ffecb3 20%, #f8bbd0 100%);
      color: #ad1457;
      font-weight: bold;
      font-size: 1.1rem;
      border: none;
      border-radius: 18px;
      padding: 10px 34px;
      margin: 16px 0 4px 0;
      cursor: pointer;
      box-shadow: 0 2px 8px #f8bbd0aa;
      transition: background .18s, transform .15s;
      outline: none;
      letter-spacing: 1px;
    }
    .btn:active {
      background: #ffd54f;
      transform: scale(0.97);
    }
    #start-screen, #gameover-screen {
      position: absolute;
      left: 0; top: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.87);
      z-index: 10;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 28px;
      text-align: center;
      box-shadow: 0 2px 12px #b3e5fc55;
    }
    #gameover-screen {
      background: rgba(255,255,255,0.96);
    }
    .gameover-title {
      font-size: 2.2rem;
      color: #e040fb;
      font-weight: bold;
      margin-bottom: 8px;
      letter-spacing: 2px;
    }
    .desc {
      color: #7c43bd;
      font-size: 1.1rem;
      margin-bottom: 12px;
      font-weight: 500;
    }
    /* 젤리 애니메이션 */
    .squash {
      animation: squash 0.25s cubic-bezier(.5,1.8,.5,1) 1;
    }
    @keyframes squash {
      0% { transform: scaleX(1.00) scaleY(1.00);}
      20% { transform: scaleX(1.18) scaleY(0.92);}
      40% { transform: scaleX(0.88) scaleY(1.13);}
      60% { transform: scaleX(1.10) scaleY(0.90);}
      80% { transform: scaleX(0.96) scaleY(1.05);}
      100% { transform: scaleX(1.00) scaleY(1.00);}
    }
    @media (max-width: 600px) {
      #game-container, #score-board { width: 98vw; min-width: 0; }
      #game-canvas { width: 96vw; height: 62vw; min-height: 220px; }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <div class="cloud c1">
      <svg width="90" height="36"><ellipse cx="45" cy="18" rx="40" ry="16" fill="#fff"/></svg>
    </div>
    <div class="cloud c2">
      <svg width="110" height="40"><ellipse cx="55" cy="20" rx="48" ry="17" fill="#fff"/></svg>
    </div>
    <div class="cloud c3">
      <svg width="60" height="24"><ellipse cx="30" cy="12" rx="24" ry="10" fill="#fff"/></svg>
    </div>
    <div class="title">말랑 젤리 스택</div>
    <div id="score-board">점수: <span id="score">0</span></div>
    <canvas id="game-canvas" width="300" height="400"></canvas>
    <div id="start-screen">
      <div style="font-size:1.8rem; color:#7c43bd; font-weight:bold; margin-bottom:12px;">말랑 젤리 스택</div>
      <div class="desc">몽환적인 구름 위에 젤리 블록을<br>최대한 높이 쌓아보세요!<br><span style="color:#ff80ab;">[탭/클릭/스페이스바]</span>로 블록을 멈출 수 있어요.</div>
      <button class="btn" id="start-btn">게임 시작</button>
    </div>
    <div id="gameover-screen" style="display:none;">
      <div class="gameover-title">게임 오버!</div>
      <div class="desc">최종 점수: <span id="final-score">0</span></div>
      <button class="btn" id="restart-btn">다시 도전</button>
    </div>
  </div>
  <script>
    // 게임 상수
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;
    const BLOCK_HEIGHT = 26;
    const INIT_BLOCK_WIDTH = 120;
    const MIN_BLOCK_WIDTH = 44;
    const BLOCK_COLORS = [
      "#ffd6e0", "#ffe082", "#b2ebf2", "#b5ead7", "#e1bee7",
      "#fff59d", "#ffccbc", "#c5cae9", "#f8bbd0", "#c8e6c9"
    ];

    // 게임 변수
    let blocks = [];
    let currBlock = null;
    let isRunning = false;
    let isGameOver = false;
    let score = 0;
    let speed = 2.1;
    let direction = 1; // 1:right, -1:left
    let animationId = null;

    // 시작 & 게임오버 화면
    const startScreen = document.getElementById('start-screen');
    const gameoverScreen = document.getElementById('gameover-screen');
    const scoreBoard = document.getElementById('score');
    const finalScore = document.getElementById('final-score');
    const startBtn = document.getElementById('start-btn');
    const restartBtn = document.getElementById('restart-btn');
    const gameContainer = document.getElementById('game-container');

    // 젤리 블록 클래스
    class Block {
      constructor(x, y, w, color) {
        this.x = x;
        this.y = y;
        this.w = w;
        this.h = BLOCK_HEIGHT;
        this.color = color;
        this.squash = false;
        this.squashTime = 0;
      }
      draw(ctx) {
        ctx.save();
        // Squash & Stretch 애니메이션
        if(this.squash) {
          const t = Math.min(this.squashTime / 15, 1);
          const scaleX = 1 + 0.16*Math.sin(Math.PI*t);
          const scaleY = 1 - 0.16*Math.sin(Math.PI*t);
          ctx.translate(this.x + this.w/2, this.y + this.h/2);
          ctx.scale(scaleX, scaleY);
          ctx.translate(-this.w/2, -this.h/2);
        } else {
          ctx.translate(this.x, this.y);
        }
        // 젤리 느낌의 둥근 사각형
        drawJellyRect(ctx, 0, 0, this.w, this.h, 18, this.color);
        ctx.restore();
        // Squash 애니메이션 시간
        if(this.squash) {
          this.squashTime++;
          if(this.squashTime > 15) {
            this.squash = false;
            this.squashTime = 0;
          }
        }
      }
    }

    // 젤리 둥근 사각형
    function drawJellyRect(ctx, x, y, w, h, r, color) {
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.lineTo(x+w-r, y);
      ctx.quadraticCurveTo(x+w, y, x+w, y+r);
      ctx.lineTo(x+w, y+h-r);
      ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
      ctx.lineTo(x+r, y+h);
      ctx.quadraticCurveTo(x, y+h, x, y+h-r);
      ctx.lineTo(x, y+r);
      ctx.quadraticCurveTo(x, y, x+r, y);
      ctx.closePath();
      ctx.fillStyle = color;
      ctx.shadowColor = color+"bb";
      ctx.shadowBlur = 12;
      ctx.fill();
      ctx.shadowBlur = 0;
      // 젤리 광택
      ctx.save();
      ctx.globalAlpha = 0.22;
      ctx.fillStyle = "#fff";
      ctx.beginPath();
      ctx.ellipse(x+w*0.38, y+h*0.29, w*0.20, h*0.28, -0.3, 0, Math.PI*2);
      ctx.fill();
      ctx.globalAlpha = 1;
      ctx.restore();
    }

    // 게임 초기화
    function initGame() {
      blocks = [];
      score = 0;
      speed = 2.1;
      direction = 1;
      isRunning = true;
      isGameOver = false;
      scoreBoard.innerText = score;
      // 첫 블록(바닥)
      blocks.push(new Block((WIDTH-INIT_BLOCK_WIDTH)/2, HEIGHT-BLOCK_HEIGHT, INIT_BLOCK_WIDTH, "#ffd6e0"));
      // 첫 움직이는 블록
      spawnBlock();
      draw();
    }

    // 블록 생성
    function spawnBlock() {
      const last = blocks[blocks.length-1];
      const w = Math.max(last.w - Math.random()*8, MIN_BLOCK_WIDTH);
      const color = BLOCK_COLORS[Math.floor(Math.random()*BLOCK_COLORS.length)];
      currBlock = new Block(direction>0 ? 0 : WIDTH-w, last.y-BLOCK_HEIGHT, w, color);
      currBlock.squash = false;
      currBlock.squashTime = 0;
      direction = direction * -1; // 교차 이동
    }

    // 메인 루프
    function draw() {
      ctx.clearRect(0,0,WIDTH,HEIGHT);
      // 배경 구름 효과
      drawCloudBG();
      // 기존 블록
      for(let b of blocks) b.draw(ctx);
      // 현재 블록
      if(currBlock) {
        currBlock.x += speed * direction;
        // 벽 반사
        if(currBlock.x <= 0) { currBlock.x = 0; direction = 1;}
        if(currBlock.x + currBlock.w >= WIDTH) { currBlock.x = WIDTH-currBlock.w; direction = -1;}
        currBlock.draw(ctx);
      }
      animationId = requestAnimationFrame(draw);
    }

    // 구름 배경
    function drawCloudBG() {
      ctx.save();
      ctx.globalAlpha = 0.08;
      for(let i=0; i<4; ++i){
        ctx.beginPath();
        ctx.arc(60+Math.sin(Date.now()/1800+i)*35, 100+i*60, 38+12*i, 0, Math.PI*2);
        ctx.arc(210+Math.cos(Date.now()/1600+i)*24, 70+i*65, 30+10*i, 0, Math.PI*2);
        ctx.fillStyle = "#fff";
        ctx.fill();
      }
      ctx.globalAlpha = 1;
      ctx.restore();
    }

    // 블록 멈추기
    function stopBlock() {
      if(!isRunning || isGameOver) return;
      // 마지막 블록
      const last = blocks[blocks.length-1];
      // 겹치는 부분 계산
      let x1 = Math.max(currBlock.x, last.x);
      let x2 = Math.min(currBlock.x + currBlock.w, last.x + last.w);
      let overlap = x2 - x1;
      // 게임오버: 겹침 없음
      if(overlap <= 0) {
        currBlock.squash = true;
        gameOver();
        return;
      }
      // 겹친 부분만 남기고 블록 추가
      currBlock.x = x1;
      currBlock.w = overlap;
      currBlock.squash = true;
      blocks.push(currBlock);
      // 점수 및 난이도
      score ++;
      scoreBoard.innerText = score;
      if(score % 5 === 0 && speed < 5.7) speed += 0.22;
      // 화면 위로 올라가면 전체 블록 내리기
      if(currBlock.y < 60) {
        for(let b of blocks) b.y += BLOCK_HEIGHT;
        if(currBlock.y < 0) {
          gameOver();
          return;
        }
      }
      // 새 블록
      spawnBlock();
    }

    // 게임 오버
    function gameOver() {
      isRunning = false;
      isGameOver = true;
      cancelAnimationFrame(animationId);
      setTimeout(()=>{
        gameoverScreen.style.display = 'flex';
        finalScore.innerText = score;
      }, 400);
    }

    // 입력 처리
    function handleInput(e) {
      if(!isRunning || isGameOver) return;
      stopBlock();
      // Squash & Stretch CSS (효과)
      const gc = document.getElementById('game-canvas');
      gc.classList.remove('squash');
      void gc.offsetWidth; // reflow
      gc.classList.add('squash');
    }

    // 모바일 터치
    canvas.addEventListener('touchstart', handleInput);
    // 마우스 클릭
    canvas.addEventListener('mousedown', handleInput);
    // 스페이스바
    window.addEventListener('keydown', function(e){
      if(e.code === 'Space') {
        e.preventDefault();
        handleInput();
      }
    });

    // 시작/재시작 버튼
    startBtn.onclick = () => {
      startScreen.style.display = 'none';
      initGame();
    };
    restartBtn.onclick = () => {
      gameoverScreen.style.display = 'none';
      initGame();
    };

    // 최초 화면
    function onLoad() {
      // 배경 구름만 그리기
      ctx.clearRect(0,0,WIDTH,HEIGHT);
      drawCloudBG();
    }
    onLoad();
  </script>
</body>
</html>
